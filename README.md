# 米家门禁控制模块

一个基于Arduino的智能门禁控制系统，支持手动和自动摘机开锁功能，可接入米家生态系统。

## 🔧 功能特性

- **手动摘机模式**：通过J1开关手动控制摘机功能
- **自动摘机开锁**：通过J2开关自动执行摘机→开锁流程
- **门铃检测**：ADC检测门铃信号（当前版本暂不可用）
- **双重开锁保障**：自动模式下进行两次开锁尝试，提高成功率
- **防抖处理**：按钮输入具备防抖功能，避免误触发
- **串口调试**：提供详细的串口输出，便于调试和监控

## 📋 硬件要求

### 微控制器
- 合宙Air001开发板
- 基于STM32G030系列芯片，支持Arduino IDE开发
- 具备PA/PB引脚定义，低功耗设计

### 外部组件
- 继电器模块 × 3（控制门铃、摘机、开锁）
- 按钮开关 × 2（手动/自动控制）
- ADC传感器（门铃信号检测）

## 🔌 引脚连接

| 功能 | 引脚 | 描述 | 连接对象 |
|------|------|------|----------|
| 门铃触发 | PA0 | K1继电器控制 | 门铃系统 |
| 摘机控制 | PA1 | K2继电器控制 | 摘机机构 |
| 开锁控制 | PA4 | K3继电器控制 | 电锁 |
| ADC采集 | PB1 | 模拟信号输入 | 门铃检测传感器 |
| 手动开关 | PB2 | 数字输入 | J1按钮 |
| 自动开关 | PB0 | 数字输入 | J2按钮 |

## ⚙️ 配置参数

```cpp
// 时间常量（毫秒）
const unsigned long DEBOUNCE_DELAY = 10;       // 按钮防抖延迟
const unsigned long DOORBELL_INTERVAL = 5000;  // 门铃触发最小间隔
const unsigned long UNLOCK_DELAY = 1000;       // 摘机到开锁延迟
const unsigned long RELAY_TRIGGER_TIME = 60;   // 继电器触发持续时间
const unsigned long UNLOCK_RETRY_DELAY = 600;  // 开锁重试间隔

// ADC阈值
const int ADC_THRESHOLD = 1;                    // 门铃触发阈值
```

## 🚀 使用方法

### 1. 硬件连接
按照引脚连接表连接所有硬件组件。

### 2. 代码上传
1. 在Arduino IDE中安装合宙Air001开发板支持包
2. 打开 `mijia-Access_control.ino`
3. 选择开发板型号为"Air001 Dev Board"
4. 连接Air001开发板并上传代码

### 3. 功能操作

#### 手动模式
1. 按下J1开关（PB2）
2. 系统触发摘机动作
3. 松开开关恢复待机状态

#### 自动模式
1. 触发J2开关（PB0，低电平有效）
2. 系统自动执行以下序列：
   - 立即摘机
   - 延迟1秒后第一次开锁
   - 延迟600ms后第二次开锁
   - 释放摘机状态

## 🔍 串口调试

连接串口监视器（115200波特率）可查看系统运行状态：

```
门铃触发
手动摘机触发
手动摘机释放
自动摘机触发
触发开锁
自动摘机释放
```

## ⚠️ 注意事项

1. **门铃功能**：当前版本的门铃检测功能暂不可用
2. **继电器类型**：确保使用低电平触发的继电器模块
3. **电源要求**：Air001开发板工作电压3.3V，继电器模块需要独立5V供电
4. **开发环境**：需要在Arduino IDE中安装合宙Air001支持包
5. **安全性**：测试时请确保门锁处于安全状态

## 🛠️ 故障排除

### 常见问题

1. **按钮无响应**
   - 检查引脚连接是否正确
   - 确认按钮接线和极性

2. **继电器不动作**
   - 检查继电器供电是否正常
   - 确认继电器触发电平（高/低电平）

3. **门铃检测异常**
   - ADC阈值可能需要调整
   - 检查传感器连接和供电

### 调试步骤
1. 打开串口监视器查看日志输出
2. 逐个测试各功能模块
3. 检查硬件连接和供电状态

## 📝 版本历史

- **v1.0**：基础功能实现
  - 手动/自动摘机控制
  - 双重开锁机制
  - 按钮防抖处理

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 📄 许可证

本项目采用开源许可证，详见 [LICENSE](LICENSE) 文件。

## 📞 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- 项目维护者：CuiYao631

---

**安全提醒**：使用本系统时请确保符合当地法律法规，并注意用电安全。
